# Telegram Bot Phoenix - Бонусная система для магазинов
Telegram Bot Phoenix - это комплексное решение для управления бонусными программами магазинов с интеграцией в кассовую систему Эвотор. 
Бот позволяет автоматизировать процессы начисления бонусов, применения скидок и взаимодействия с покупателями через Telegram.

## Ключевые возможности:
  - 🎁 Автоматическое применение скидок до 50% от суммы покупки
  - 💰 Начисление бонусов (12% от суммы покупки)
  - 📱 Регистрация пользователей по номеру телефона
  - 💳 Виртуальные карты лояльности в виде QR-кодов
  - 🔄 Синхронизация с Эвотор через REST API
  - 📊 Управление балансом и историей транзакций

## Технологический стек
  - Язык: C# (.NET 6)
  - База данных: SQLite
  - Интеграции:
      - Telegram Bot API
      - Evotor REST API
  
  - **Библиотеки**:
    - Telegram.Bot
    - Microsoft.Data.Sqlite
    - ZXing.Net (генерация QR-кодов)
    - SixLabors.ImageSharp (обработка изображений)
    - DotNetEnv (управление переменным окружением)
   
## Установка и запуск

### Предварительные требования:
  - .NET 6+ SDK
  - SQLite3
  - Аккаунт в Telegram для бота
  - Доступ к API Эвотор

### Настройка окружения
  1. Клонируйте репозиторий
```
git clone https://github.com/MrNikto1/Telegram-bot-phoenix.git
cd Telegram-bot-phoenix
```
  2. Создайте файл .env в корне проекта со следующим содержимым: 
```
TOKEN_TELEGRAM=ваш_токен_бота_telegram
QR_SECRET_KEY=секретный_ключ_для_токенов
API_BASE_URL=базовый_url_вашего_сервера
EVOTOR_ORG_UUID=идентификатор_организации_эвотор
EVOTOR_ACCESS_TOKEN=токен_доступа_эвотор
```
  3. Восстановите зависимости:
```dotnet restore```
  4. Запустите приложение:
```dotnet run```

## Основные функции
### Для покупателей
  
  1. Регистрация в системе:
        - Регистрация по номеру телефона
        - Получение стартовых бонусов (1000 баллов)
  2. Управление балансом:
        - Просмотр текущего баланса
        - История транзакций
  3. Применение скидок:
        - Генерация QR-кода для скидки
        - Автоматическое применение скидки до 50% от суммы покупки
  4. Начисление бонусов:
        - Автоматическое начисление 12% от суммы покупки
        - Уведомления о начислении
     
### Для продавцов

  1. Сканирование QR-кодов:
       - Сканирование виртуальных карт
       - Применение скидок через API
  2. Интеграция с Эвотор:
        - Автоматическое создание товара-скидки
        - Синхронизация данных в реальном времени
        - Управление чеками через API
  3. Администрирование:
        - Просмотр статистики
        - Управление бонусной программой

## Архитектура системы
```
┌─────────────────┐       ┌──────────────────┐       ┌──────────────┐
│   Telegram Bot  │─────▶│  DiscountService │─────▶│   Database   │
└─────────────────┘       └──────────────────┘       └──────────────┘
        │                          │
        ▼                          ▼
┌─────────────────┐       ┌──────────────────┐
│  QrCodeService  │       │  EvotorService   │
└─────────────────┘       └──────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │   Evotor API     │
                       └──────────────────┘
```
## Интеграция с Эвотор
Бот использует Evotor API для:
  1. Создания товара-скидки с отрицательной ценой
  2. Автоматического добавления скидки в чек
  3. Синхронизации данных о покупках
  4. Управления товарами через REST API

Для работы с Эвотор API необходимы:
  - Индентификатор организации (EVOTOR_ORG_UUID)
  -  Токен доступа (EVOTOR_ACCESS_TOKEN)

## Примеры использования
### Генерация QR-кода для скидки
```cs
var (qrStream, token, expiry) = qrService.GenerateDiscountQrCode(userId, maxDiscount);
```
### Применения скидки в Эвотор
```cs
await evotorDiscountManager.ApplyDiscountToTerminal(
    storeUuid, 
    discountAmount
);
```

### Начисление бонусов
``` cs
int bonuses = (int)(purchaseAmount * (Program.BonusPercentage / 100.0));
await AddBonusesToUser(userId, bonuses);
```
---

